{{ define "css-jots/show" }}
    <link href="/css/quill.core.css" rel="stylesheet">
    <style>
        .jot-page {
            width: 100%;
            height: 100%;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .jot-page .body {
            flex: 1;
            width: 50%;
            min-width: 40em;

            outline: none;
            font-family: monospace;
            font-size: 15px;
        }

        .jot-page footer {
            width: 50%;
            min-width: 40em;

            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .jot-page footer .buttons a {
          margin-right: 0.75em;
        }

        .jot-page footer .sync-status {
            color: gray;
        }

        @media screen and (max-width: 480px) {
            .jot-page .body {
                width: 100%;
                min-width: 0;
            }

            .jot-page footer {
                width: 100%;
                min-width: 0;
            }
        }
    </style>
{{ end }}

<div class="jot-page">
    <div id="body" class="body"></div>

    <footer>
        <div class="buttons">
          <a href="/home">home</a>
          <a id="delete" href="#">delete</a>
        </div>

        <p id="sync-status" class="sync-status">saved</p>
    </footer>
</div>

<script src="/js/quill.min.js"></script>
<script type="application/javascript">
  const id = "{{ .id }}";
  const saveDelayMs = 750;
  const quillArgs = ['#body', {placeholder: 'jot something...'}];

  document.addEventListener('DOMContentLoaded', () => {
    const quill = new Quill(...quillArgs);
    const syncStatus = document.getElementById('sync-status');

    // Start quill
    quill.setContents({{ .contents }});
    quill.focus();
    quill.setSelection(quill.getLength());

    // Sync request
    const sync = () => {
      syncStatus.innerText = 'saving...';
      const fetchOptions = {
        method: 'put',
        body: JSON.stringify({body: quill.getText(), contents: quill.getContents()})
      };

      fetch(`/jot/${id}/sync`, fetchOptions)
        .catch(console.log)
        .then((response) => response.json())
        .then((json) => syncStatus.innerText = 'saved');
    };

    // Handle text change event
    let lastUpdate = null;
    let lastTimeout = null;
    quill.on('text-change', (event) => {
      lastUpdate = Date.now();
      syncStatus.innerText = 'not saved';

      if (lastTimeout) clearTimeout(lastTimeout);
      lastTimeout = setTimeout(() => {
        if (lastUpdate && (new Date()) - lastUpdate > saveDelayMs) sync();
      }, saveDelayMs);
    });

    // Save when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (lastTimeout) clearTimeout(lastTimeout);
      sync();
    });

    // Delete link
    document.getElementById('delete').addEventListener('click', (event) => {
      event.preventDefault();

      if (confirm('are you sure you want to delete this jot?')) {
        fetch(`/jot/${id}`, {method: 'delete'}).then(() => window.location.href = '/home')
      }
    });
  });
</script>
